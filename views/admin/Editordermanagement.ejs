<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Order Details</title>
  <link rel="stylesheet" href="/css/admin.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/css/bootstrap.min.css">
</head>

<body>
  <div class="container-scroller ">
    <!-- Sidebar -->
    <nav class="sidebar sidebar-offcanvas" id="sidebar">
      <div class="sidebar-brand-wrapper d-none d-lg-flex align-items-center justify-content-center fixed-top">
        <a class="sidebar-brand brand-logo" href="#">MEN'S HUB </a>
        <a class="sidebar-brand brand-logo-mini" href="#"><img src="/images/logo-mini.svg" alt="logo" /></a>
        <a href="/home"><img style="width: 30px;height: 30px;" src="/images/img/home-logo/home2.png" alt="To home"></a>
      </div>
      <ul class="nav">
        <li class="nav-item menu-items">
          <a class="nav-link" href="#">
            <span class="menu-title">Dashboard</span>
          </a>
        </li>
        <li class="nav-item menu-items ">
          <a class="nav-link" href="/admin/usermanagement">
            <span class="menu-title">User Management</span>
          </a>
        </li>
        <li class="nav-item menu-items">
          <a class="nav-link" href="/admin/products">
            <span class="menu-title">Products Management</span>
          </a>
        </li>
        <li class="nav-item menu-items forme">
          <a class="nav-link" href="/admin/ordermanagement">
            <span class="menu-title">Order Management</span>
          </a>
        </li>
        <li class="nav-item menu-items ">
          <a class="nav-link" href="/admin/categorymanagement">
            <span class="menu-title">Category Management</span>
          </a>
        </li>
        <li class="nav-item menu-items">
          <a class="nav-link" href="/admin/couponmanagement">
            <span class="menu-title">Coupen Management</span>
          </a>
        </li>
        <li class="nav-item menu-items">
          <a class="nav-link" href="/admin/offermanagement">
            <span class="menu-title">Offer Management</span>
          </a>
        </li>
      </ul>
    </nav>

    <!-- Page Content -->
    <div class="container-fluid page-body-wrapper" style="background-color: #191c24; color: white;">
      <div class="custom-table-container mt-5">
        <h3 class="text-center">Order Details</h3>

        <!-- Product Details -->
        <div class="order-section">
          <h4>Product Details</h4>
          <table class="table table-bordered">
            <thead class="thead-dark">
              <tr>
                <th>Product Image</th>
                <th>Product Name</th>
                <th>Price</th>
                <th>Quantity</th>
              </tr>
            </thead>
            <tbody>
              <% productsDetails.forEach(item=> { %>
                <tr>
                  <td><img src="/<%= item.productData.images[0] %>" alt="<%= item.productData.name %>"
                      style="width: 100px; height: auto;"></td>
                  <td>
                    <%= item.productData.name %>
                  </td>
                  <td>
                    <%= item.price.toFixed(2) %>
                  </td>
                  <td>
                    <%= item.quantity %>
                  </td>
                </tr>
                <% }) %>
            </tbody>
          </table>
        </div>

        <!-- Shipping Details -->
        <div class="order-section mt-5">
          <h4>Shipping Details</h4>
          <table class="table table-bordered">
            <thead class="thead-dark">
              <tr>
                <th>House Name</th>
                <th>Country</th>
                <th>State</th>
                <th>District</th>
                <th>City</th>
                <th>Pincode</th>
              </tr>
            </thead>
          </table>
        </div>

        <!-- Order Status -->
        <div class="order-status-section mt-5">
          <h4>Order Status</h4>
          <form id="statusForm" method="POST">
            <div class="form-group" id="statusDropdownContainer">
              <label for="orderStatus">Status:</label>
              <select class="form-control" id="orderStatus">
                <option value="pending" <%=order.status==='pending' ? 'selected' : '' %>>Pending</option>
                <option value="completed" <%=order.status==='completed' ? 'selected' : '' %>>Completed</option>
                <option value="cancelled" <%=order.status==='cancelled' ? 'selected' : '' %>>Cancelled</option>
              </select>
            </div>
            <button type="submit" class="btn btn-primary">Update Status</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <script>
    // Wait for the DOM to be fully loaded before running the script
    document.addEventListener('DOMContentLoaded', function () {
      const currentStatus = '<%= order.status %>';
      const statusDropdownContainer = document.getElementById('statusDropdownContainer');

      console.log('Current Status:', currentStatus); // Debugging the order status

      if (currentStatus === 'cancelled') {
        statusDropdownContainer.style.display = 'none'; // Hide the status dropdown if the order is cancelled
      }
    });

    // Form submission handler
    document.getElementById('statusForm').addEventListener('submit', async function (e) {
      e.preventDefault(); // Prevent the default form submission
      const status = document.getElementById('orderStatus').value; // Get the new status value
      const orderId = '<%= order._id %>'; // Use the server-rendered order ID

      try {
        // Send the new status to the server
        const response = await fetch(`/admin/order/${orderId}/updatestatus`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ status }),
        });

        const data = await response.json(); // Parse the JSON response

        if (data.success) {
          // Display a success Swal alert
          Swal.fire({
            title: 'Success!',
            text: data.message,
            icon: 'success',
            confirmButtonText: 'OK',
          }).then(() => {
            location.reload(); // Reload the page after the user confirms
          });
        } else {
          // Display an error Swal alert with the server's message
          Swal.fire({
            title: 'Error!',
            text: data.message,
            icon: 'error',
            confirmButtonText: 'OK',
          });
        }
      } catch (error) {
        // Display a generic error Swal alert if the fetch fails
        Swal.fire({
          title: 'Error!',
          text: 'Something went wrong while updating the status. Please try again later.',
          icon: 'error',
          confirmButtonText: 'OK',
        });
        console.error('Error updating status:', error); // Log the error for debugging
      }
    });
  </script>
</body>

</html>